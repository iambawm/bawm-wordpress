!function(e){"use strict";function i(e){return!e||e.indexOf("://")>0||0===e.indexOf("//")?e:e=0===e.indexOf("/")?aiovg_form.site_url+e:aiovg_form.site_url+"/"+e}function a(i,a){e("#aiovg-field-"+i).addClass("aiovg-field-invalid").find(".aiovg-field-error").html(a)}function o(i){e("#aiovg-field-"+i).removeClass("aiovg-field-invalid").find(".aiovg-field-error").html("")}function t(i){e("#aiovg-field-"+i+" .aiovg-media-uploader").removeClass("aiovg-uploading").find(".aiovg-upload-progress").html("")}e(function(){var n=i(e("#aiovg-mp4").val());if(aiovg_form.magic_field){var r={action:"aiovg_public_get_magic_field",security:aiovg_form.ajax_nonce};e.post(aiovg_form.ajax_url,r,function(i){i&&e("#aiovg-form-video").append(i)})}if(e("#aiovg-type","#aiovg-form-video").on("change",function(i){i.preventDefault();var a=e(this).val();e(".aiovg-toggle-fields").hide(),e(".aiovg-type-"+a).show()}).trigger("change"),e(".aiovg-media-uploader","#aiovg-form-video").each(function(){var i=e(this),n=i.find(".aiovg-button-upload").data("format"),r=i.find(".aiovg-upload-progress"),l={runtimes:"html5,html4",browse_button:"aiovg-button-upload-"+n,container:"aiovg-field-"+n,file_data_name:"async-upload",multiple_queues:!1,max_file_count:1,url:aiovg_form.ajax_url,multipart:!0,multi_selection:!1,multipart_params:{action:"aiovg_public_upload_media",security:aiovg_form.ajax_nonce,post_id:e("#aiovg-post_id").val(),field:n}};"image"==n?l.filters={max_file_size:aiovg_form.max_upload_size,mime_types:[{title:aiovg_form.i18n.allowed_files,extensions:aiovg_form.supported_image_formats}]}:(l.chunk_size=aiovg_form.chunk_size,l.filters={max_file_size:aiovg_form.max_upload_size,mime_types:[{title:aiovg_form.i18n.allowed_files,extensions:aiovg_form.supported_video_formats}]});var d=new plupload.Uploader(l);d.init(),d.bind("FilesAdded",function(i,a){o(n),e("#aiovg-field-"+n+" .aiovg-media-uploader").addClass("aiovg-uploading").find(".aiovg-upload-progress").html(aiovg_form.i18n.please_wait),i.refresh(),i.start(),e("#aiovg-field-"+n+" .aiovg-upload-cancel").off("click").on("click",function(e){e.preventDefault(),i.stop(),i.removeFile(a[0]),i.refresh(),t(n)})}),d.bind("UploadProgress",function(e,i){var a=aiovg_form.i18n.upload_status.replace("%d",i.percent);100==i.percent&&(a+=" "+aiovg_form.i18n.please_wait),r.html(a)}),d.bind("Error",function(e,i){var o=i.message;-600===i.code&&(o=aiovg_form.i18n.invalid_file_size),t(n),a(n,o)}),d.bind("FileUploaded",function(i,a,o){if(t(n),"200"==o.status)try{var r=e.parseJSON(o.response);r.success?e("#aiovg-"+n).val(r.data.url).trigger("file.uploaded"):i.trigger("error",{code:null,message:r.data})}catch(l){i.trigger("error",{code:null,message:r.response})}else i.trigger("error",{code:o.code,message:aiovg_form.i18n.unknown_error})})}),e("#aiovg-html5-thumbnail-generator").length){var l=document.getElementById("aiovg-thumbnail-generator-modal-body").innerHTML;e("#aiovg-html5-thumbnail-generator").magnificPopup({items:{src:"#aiovg-thumbnail-generator-modal",type:"inline"},callbacks:{open:function(){if(document.getElementById("aiovg-thumbnail-generator-modal-body").innerHTML=l,n=i(document.getElementById("aiovg-mp4").value)){var a=document.getElementById("aiovg-thumbnail-generator-player"),o=document.getElementById("aiovg-thumbnail-generator-canvas"),t=o.getContext("2d"),r=document.getElementById("aiovg-thumbnail-generator-seekto"),d=document.getElementById("aiovg-thumbnail-generator-button");a.src=n,a.load(),a.addEventListener("error",function(){var i='<div class="aiovg-notice aiovg-notice-error">'+aiovg_form.i18n.thumbnail_generator_cors_error+"</div>";e("#aiovg-thumbnail-generator-modal-body").prepend(i)},!0),a.addEventListener("loadedmetadata",function(){var i=a.duration,l="";o.width=a.videoWidth,o.height=a.videoHeight;for(var v=0;v<Math.floor(i);v+=4)l+='<option value="'+v+'">'+v+"</option>";r.innerHTML=l,r.disabled=!1,d.disabled=!1,r.addEventListener("change",function(){a.currentTime=e(this).val(),r.disabled=!0,d.disabled=!0}),a.addEventListener("timeupdate",function(){r.disabled=!1,d.disabled=!1});var g=!1;d.addEventListener("click",function(){if(g)return!1;g=!0,e(this).before('<div class="aiovg-spinner"></div>&nbsp;'),t.drawImage(a,0,0,a.videoWidth,a.videoHeight);var i,l="";try{l=o.toDataURL()}catch(v){e("#aiovg-thumbnail-generator-modal-body").find(".aiovg-spinner").remove(),r.disabled=!0,d.disabled=!0;var u='<div class="aiovg-notice aiovg-notice-error">'+aiovg_form.i18n.thumbnail_generator_cors_error+"</div>";return e("#aiovg-thumbnail-generator-modal-body").prepend(u),!1}var s=new FormData;s.append("action","aiovg_upload_base64_image"),s.append("video",n),s.append("index",e("#aiovg-thumbnail-generator .aiovg-item-thumbnail").length),s.append("security",aiovg_form.ajax_nonce);var m=function e(i){a=i.split(",")[0].indexOf("base64")>=0?atob(i.split(",")[1]):unescape(i.split(",")[1]);for(var a,o=i.split(",")[0].split(":")[1].split(";")[0],t=new Uint8Array(a.length),n=0;n<a.length;n++)t[n]=a.charCodeAt(n);return new Blob([t],{type:o})}(l);s.append("image_data",m,"temp.png"),(i=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")).onreadystatechange=function(){4==i.readyState&&200==i.status&&(e("#aiovg-thumbnail-generator-modal-body").find(".aiovg-spinner").remove(),""!=i.responseText&&(e(i.responseText).insertBefore("#aiovg-html5-thumbnail-generator"),e("#aiovg-thumbnail-generator input[type=radio]:last").prop("checked",!0).trigger("change")),e("#aiovg-thumbnail-generator .aiovg-item-thumbnail").length>0?(e("#aiovg-thumbnail-generator .aiovg-header").html(aiovg_form.i18n.thumbnail_generator_select_image),e("#aiovg-thumbnail-generator .aiovg-footer").show()):(e("#aiovg-thumbnail-generator .aiovg-header").html(aiovg_form.i18n.thumbnail_generator_capture_image),e("#aiovg-thumbnail-generator .aiovg-footer").hide()),e.magnificPopup.close())},i.open("POST",aiovg_form.ajax_url),i.send(s)})})}else{var v='<div class="aiovg-notice aiovg-notice-error">'+aiovg_form.i18n.thumbnail_generator_video_not_found+"</div>";e("#aiovg-thumbnail-generator-modal-body").prepend(v)}},close:function(){document.getElementById("aiovg-thumbnail-generator-modal-body").innerHTML=""}}})}e("#aiovg-mp4").on("blur file.uploaded",function(){if(!aiovg_form.ffmpeg_enabled)return!1;var a=i(e(this).val());if(!a||a==n)return!1;n=a;var o='<span class="aiovg-spinner"></span> ';o+="<span>"+aiovg_form.i18n.thumbnail_generator_processing+"</span>",e("#aiovg-thumbnail-generator").show().addClass("aiovg-processing").find(".aiovg-header").html(o);var t={action:"aiovg_ffmpeg_generate_images",url:n,security:aiovg_form.ajax_nonce};e.post(aiovg_form.ajax_url,t,function(i){if(e("#aiovg-thumbnail-generator").removeClass("aiovg-processing").find(".aiovg-header").html(""),e("#aiovg-thumbnail-generator .aiovg-item-thumbnail").remove(),i&&(aiovg_form.html5_thumbnail_generator_enabled?e(i).insertBefore("#aiovg-html5-thumbnail-generator"):e("#aiovg-thumbnail-generator .aiovg-body").html(i),""==e("#aiovg-image").val()&&e("#aiovg-thumbnail-generator input[type=radio]:first").prop("checked",!0).trigger("change")),e("#aiovg-thumbnail-generator .aiovg-item-thumbnail").length>0)e("#aiovg-thumbnail-generator .aiovg-header").html(aiovg_form.i18n.thumbnail_generator_select_image),e("#aiovg-thumbnail-generator .aiovg-footer").show();else{var a="";a=aiovg_form.html5_thumbnail_generator_enabled?'<span class="aiovg-field-error">'+aiovg_form.i18n.ffmpeg_thumbnail_generation_failed+"</span> <span>"+aiovg_form.i18n.thumbnail_generator_capture_image+"</span>":'<span class="aiovg-field-error">'+aiovg_form.i18n.ffmpeg_thumbnail_generation_failed+"</span>",e("#aiovg-thumbnail-generator .aiovg-header").html(a),e("#aiovg-thumbnail-generator .aiovg-footer").hide()}})}),e("#aiovg-thumbnail-generator").on("click",".aiovg-item-thumbnail",function(){e(this).find("input[type=radio]").prop("checked",!0).trigger("change")}),e("#aiovg-thumbnail-generator").on("change","input[type=radio]",function(){var i=e("#aiovg-thumbnail-generator input[type=radio]:checked").val();e("#aiovg-image").val(i)}),e("#aiovg-title").on("keyup",function(){""==e(this).val()?a("title",aiovg_form.i18n.required):o("title")}),e("#aiovg-mp4").on("keyup",function(){""==e(this).val()?a("mp4",aiovg_form.i18n.required):o("mp4")}),e("#aiovg-adaptive").on("keyup",function(){""==e(this).val()?a("adaptive",aiovg_form.i18n.required):o("adaptive")}).on("blur",function(){var i=e(this).val();i&&!/mpd|m3u8/.test(i.toLowerCase())&&(e("#aiovg-adaptive").val(""),a("adaptive",aiovg_form.i18n.invalid_file_format))}),e("#aiovg-youtube").on("keyup",function(){""==e(this).val()?a("youtube",aiovg_form.i18n.required):o("youtube")}).on("blur",function(){var i=e(this).val(),o=RegExp("youtube.com|youtu.be");i&&!o.test(i.toLowerCase())&&(e("#aiovg-youtube").val(""),a("youtube",aiovg_form.i18n.invalid_video_url))}),e("#aiovg-vimeo").on("keyup",function(){""==e(this).val()?a("vimeo",aiovg_form.i18n.required):o("vimeo")}).on("blur",function(){var i=e(this).val(),o=RegExp("vimeo.com");i&&!o.test(i.toLowerCase())&&(e("#aiovg-vimeo").val(""),a("vimeo",aiovg_form.i18n.invalid_video_url))}),e("#aiovg-dailymotion").on("keyup",function(){""==e(this).val()?a("dailymotion",aiovg_form.i18n.required):o("dailymotion")}).on("blur",function(){var i=e(this).val(),o=RegExp("dailymotion.com");i&&!o.test(i.toLowerCase())&&(e("#aiovg-dailymotion").val(""),a("dailymotion",aiovg_form.i18n.invalid_video_url))}),e("#aiovg-rumble").on("keyup",function(){""==e(this).val()?a("rumble",aiovg_form.i18n.required):o("rumble")}).on("blur",function(){var i=e(this).val(),o=RegExp("rumble.com");i&&!o.test(i.toLowerCase())&&(e("#aiovg-rumble").val(""),a("rumble",aiovg_form.i18n.invalid_video_url))}),e("#aiovg-facebook").on("keyup",function(){""==e(this).val()?a("facebook",aiovg_form.i18n.required):o("facebook")}).on("blur",function(){var i=e(this).val(),o=RegExp("facebook.com");i&&!o.test(i.toLowerCase())&&(e("#aiovg-facebook").val(""),a("facebook",aiovg_form.i18n.invalid_video_url))}),e("#aiovg-tos").on("change",function(){e("#aiovg-tos").is(":checked")?e("#aiovg-field-tos").removeClass("aiovg-field-invalid"):e("#aiovg-field-tos").addClass("aiovg-field-invalid")});var d=!1;e("#aiovg-form-video").on("submit",function(i){if(d)return!1;if(d=!0,e(this).find(".aiovg-uploading").length>0)return d=!1,alert(aiovg_form.i18n.pending_upload),!1;var t=i.target,n=!1;""==e("#aiovg-title").val()?(a("title",aiovg_form.i18n.required),n=!0):o("title");var r=e("#aiovg-field-type select").val();"default"==r&&(r="mp4"),""==e("#aiovg-"+r).val()?(a(r,aiovg_form.i18n.required),n=!0):o(r),e("#aiovg-tos").length>0&&(e("#aiovg-tos").is(":checked")?e("#aiovg-field-tos").removeClass("aiovg-field-invalid"):(e("#aiovg-field-tos").addClass("aiovg-field-invalid"),n=!0)),t.checkValidity()||(n=!0),!0==n&&(i.preventDefault(),i.stopImmediatePropagation(),d=!1,e("html, body").animate({scrollTop:e(":invalid, .aiovg-field-invalid","#aiovg-form-video").first().offset().top-75},300))})})}(jQuery);